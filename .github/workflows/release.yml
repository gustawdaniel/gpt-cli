name: Release

on:
  release:
    types: [ created ]

jobs:
  gnu-bash:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
      - name: Install clipboard deps
        run: sudo apt install xorg-dev libxcb-composite0-dev
      - run: cargo build --target x86_64-unknown-linux-gnu --release
      - run: cp target/x86_64-unknown-linux-gnu/release/gpt-cli gpt-cli.gnu
      - run: shasum -a 256 gpt-cli.gnu | cut -d " " -f 1 > gpt-cli.gnu.sha256.txt
      - name: Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        with:
          files: |
            gpt-cli.gnu
            gpt-cli.gnu.sha256.txt
      - name: Update fallback release URL
        run: sed -i "s|FALLBACK_RELEASE_URL=.*|FALLBACK_RELEASE_URL=https://api.github.com/repos/gustawdaniel/gpt-cli/releases/${{ github.event.release.id }}|" install.sh
      - name: Commit changes
        uses: EndBug/add-and-commit@v9
        with:
          author_name: Daniel Gustaw
          author_email: gustaw.daniel@gmail.com
          message: "updated fallback release url to ${{ github.event.release.id }}"
          add: 'install.sh'
          push: origin HEAD:main

  aur:
    runs-on: archlinux
    steps:
      - uses: actions/checkout@master
      - name: Get release information
        run: |
          RELEASE_TAG=${{ github.event.release.tag_name }}
          echo "Release tag: $RELEASE_TAG"
          echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV
      - name: Use release information
        run: |
          echo "Using release tag: $RELEASE_TAG"

  musl-docker:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
      - run: sudo apt install musl-tools
      - run: rustup target add x86_64-unknown-linux-musl
      - run: cargo build --target x86_64-unknown-linux-musl --release
      - run: docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/gpt-cli .
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/gpt-cli

      - run: cp target/x86_64-unknown-linux-musl/release/gpt-cli gpt-cli.musl
      - run: shasum -a 256 gpt-cli.musl | cut -d " " -f 1 > gpt-cli.musl.sha256.txt
      - name: Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        with:
          files: |
            gpt-cli.musl
            gpt-cli.musl.sha256.txt

  cargo:
    permissions:
      pull-requests: write
      contents: write
    name: Release-plz
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Run release-plz
        uses: MarcoIeni/release-plz-action@v0.4
        with:
          command: release
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}