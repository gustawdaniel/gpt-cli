name: Debug

on:
  push:
    branches: ['*']
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - name: Install base-devel
        run: |
          pacman -Syu --noconfirm base-devel wget bc
      - name: Setup environment
        run: |
          echo "PKGVER=0.0.14" >> $GITHUB_ENV
          echo "PKGREL=$(echo "1+$(curl "https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD?h=gpt-cli" | head -n 3 | tail -n 1 | cut -d "=" -f 2)" | bc)" >> $GITHUB_ENV
      - run: echo ${{ env.PKGVER }}
      - name: Setup environment2
        run: |
          wget "https://github.com/gustawdaniel/gpt-cli/releases/download/v${{ env.PKGVER }}/gpt-cli" -O gpt-cli.gnu
          echo "CHECKSUM=$(sha512sum gpt-cli.gnu | cut -d " " -f 1)" >> $GITHUB_ENV

      - name: Prepare PKGBUILD
        run: |
          cat <<EOT >> PKGBUILD
          pkgname=gpt-cli
          pkgver=${{ env.PKGVER }}
          pkgrel=${{ env.PKGREL }}
          pkgdesc="Run linux commands with natural language. Eg 'show my graphic card' instead 'lspci | grep VGA'"
          arch=('x86_64')
          url="https://github.com/gustawdaniel/gpt-cli"
          license=('MIT')
          depends=('xorg-server-devel' 'libxcb')
          options=()
          source_x86_64=("https://github.com/gustawdaniel/gpt-cli/releases/download/v${{ env.PKGVER }}/gpt-cli.gnu")
          sha512sums_x86_64=('${{ env.CHECKSUM }}')
          
          package() {
          # Install the binary
          install -Dm755 "\$srcdir/gpt-cli" "\$pkgdir/usr/bin/gpt-cli"
          
          # Create a symbolic link
          ln -s "/usr/bin/gpt-cli" "\$pkgdir/usr/bin/p"
          }
          EOT

      - name: Generate .SRCINFO
        run: |
          useradd -m builduser
          passwd -d builduser
          echo "builduser ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/builduser
          chown -R builduser:builduser .
          sudo -u builduser bash -c "makepkg --printsrcinfo > .SRCINFO"

      - name: Show files
        run: |
          ls -la
          cat PKGBUILD
          cat .SRCINFO

      - run: echo "${{ secrets.ID_ED25519 }}" > /github/home/.ssh/id_ed25519
      - run: echo "${{ secrets.ID_ED25519_PUB }}" > /github/home/.ssh/id_ed25519.pub
      - run: chmod 600 /github/home/.ssh/id_ed25519
      - run: git config --global user.email "gustaw.daniel@gmail.com"
      - run: git config --global user.name "Daniel Gustaw"
      - run: git config --unset-all http.https://github.com/.extraheader
      - run: git init
      - run: ls -la /github/home/.ssh
      - run: whoami
      - run: git remote add aur ssh://aur@aur.archlinux.org/gpt-cli.git

      - name: Commit and push
        run: |
          git add PKGBUILD .SRCINFO
          git commit -m "Release ${{ env.PKGVER }}-${{ env.PKGREL }}"
          git push aur HEAD:master